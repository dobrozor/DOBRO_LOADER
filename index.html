<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω —Ç–µ–ø–µ—Ä—å —Å–≤–µ—Ç–ª—ã–π */
        body { background: #f8fafc; color: #1e293b; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞ –Ω–∞ —Å–≤–µ—Ç–ª–æ–º —Ñ–æ–Ω–µ */
        .download-item { border-bottom: 1px solid #e2e8f0; background: white; transition: background 0.2s; }
        .download-item:hover { background: #f1f5f9; }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã */
        .progress-bg { background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-fill { background: #3b82f6; width: 0%; height: 100%; transition: width 0.3s; }

        /* –û–ö–ù–û –õ–û–ì–ê - –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–µ–º–Ω—ã–º, –∫–∞–∫ –≤—ã –ø—Ä–æ—Å–∏–ª–∏ */
        .log-panel { background: #0f172a; border-left: 2px solid #1e293b; display: none; box-shadow: -10px 0 15px -3px rgba(0, 0, 0, 0.1); }
        #log-content { color: #10b981; } /* –ò–∑—É–º—Ä—É–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ç–µ–º–Ω–æ–º —Ñ–æ–Ω–µ */
    </style>
</head>
<body class="flex flex-col">
    <div class="flex items-center justify-between p-4 bg-white border-b border-slate-200 shadow-sm z-10">
        <div class="flex items-center gap-3">
            <img src="https://github.com/dobrozor/DOBRO_LOADER/blob/master/logo.png?raw=true" class="h-16">
        </div>
        <div class="flex gap-2">
            <button onclick="pickFile()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition shadow-md">
                <span>+</span> –î–û–ë–ê–í–ò–¢–¨ JSON
            </button>
            <button onclick="startAll()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-md">
                ‚ñ∂ –°–ö–ê–ß–ê–¢–¨ –í–°–ï
            </button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <div class="flex-1 overflow-y-auto custom-scroll bg-slate-50" id="tasks-list">
            </div>

        <div id="log-panel" class="w-1/3 log-panel flex flex-col">
            <div class="p-3 border-b border-slate-800 flex justify-between items-center gap-2 bg-slate-900">
                <span class="text-xs font-bold text-slate-400 truncate flex-1">
                    –õ–û–ì: <span id="current-log-title" class="text-slate-200">-</span>
                </span>
                <div class="flex items-center gap-2">
                    <button onclick="copyCurrentLog(event)" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded border border-slate-700 transition">
                        üìã –ö–û–ü–ò–†–û–í–ê–¢–¨
                    </button>
                    <button onclick="closeLog()" class="text-slate-500 hover:text-white px-1">‚úï</button>
                </div>
            </div>
            <div id="log-content" class="p-4 font-mono text-[10px] overflow-y-auto flex-1 custom-scroll">
                <div class="text-slate-500">> –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–∞</div>
            </div>
        </div>
    </div>

    <script>
        let tasks = {};

        async function pickFile() {
            const results = await pywebview.api.select_json();
            if (results && Array.isArray(results)) {
                // –ò—Ç–µ—Ä–∏—Ä—É–µ–º –ø–æ –≤—Å–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º
                results.forEach(task => {
                    createTaskRow(task);
                });
            }
        }

        function createTaskRow(data) {
            const id = data.id;
            tasks[id] = { ...data, logs: [] };

            const row = document.createElement('div');
            row.id = `task-${id}`;
            row.className = 'download-item p-4 flex items-center gap-4';
            row.innerHTML = `
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-semibold text-slate-800 truncate" title="${data.filename}">${data.filename}</div>
                    <div class="text-[10px] text-slate-500 mt-1 uppercase font-bold">${data.quality_label || 'JSON'}</div>
                </div>

                <div class="flex items-center gap-2">
                    <button onclick="removeTask('${id}')" class="bg-red-50 hover:bg-red-100 p-2 rounded text-red-500 transition border border-red-100">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </div>

                <div class="w-48">
                    <div class="flex justify-between mb-1">
                        <span id="status-${id}" class="text-[10px] text-slate-500 font-medium italic">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
                        <span id="percent-${id}" class="text-[10px] font-bold text-blue-600">0%</span>
                    </div>
                    <div class="progress-bg">
                        <div id="bar-${id}" class="progress-fill"></div>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <select id="select-${id}" class="bg-white border border-slate-300 text-slate-700 text-[11px] rounded px-2 py-1 outline-none focus:ring-2 focus:ring-blue-500">
                        ${data.qualities.map(q => `<option value="${q}">${q}p</option>`).join('')}
                    </select>

                    <button id="btn-${id}" onclick="startTask('${id}')" class="bg-emerald-600 hover:bg-emerald-700 p-2 rounded text-white transition shadow-sm">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M15.41 12.59L10.5 15.5C10.1 15.74 9.5 15.45 9.5 14.91V9.09C9.5 8.55 10.1 8.26 10.5 8.5L15.41 11.41C15.8 11.65 15.8 12.35 15.41 12.59Z" fill="currentColor"/>
                        </svg>
                    </button>

                    <button onclick="showLog('${id}')" class="bg-slate-200 hover:bg-slate-300 p-2 rounded text-slate-700 transition border border-slate-300">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h7"/></svg>
                    </button>
                </div>
            `;
            document.getElementById('tasks-list').appendChild(row);
        }

        function startTask(id) {
            const q = document.getElementById(`select-${id}`).value;
            document.getElementById(`btn-${id}`).disabled = true;
            document.getElementById(`btn-${id}`).classList.add('opacity-30');
            pywebview.api.start_download(id, q);
        }

        function showLog(id) {
            document.getElementById('log-panel').style.display = 'flex';
            document.getElementById('current-log-title').innerText = tasks[id].filename;
            renderLog(id);
        }

        async function copyCurrentLog() {
    const container = document.getElementById('log-content');
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç, –∏–≥–Ω–æ—Ä–∏—Ä—É—è HTML-—Ç–µ–≥–∏ (–º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø—Ä–æ—á–µ–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ —Ç–µ–∫—Å—Ç)
    const logText = container.innerText;

    if (!logText || logText.includes("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É")) {
        return;
    }

    try {
        await navigator.clipboard.writeText(logText);

        // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫–µ
        const btn = event.currentTarget;
        const originalText = btn.innerText;
        btn.innerText = "‚úÖ –°–ö–û–ü–ò–†–û–í–ê–ù–û";
        btn.classList.replace('bg-slate-800', 'bg-emerald-900');

        setTimeout(() => {
            btn.innerText = originalText;
            btn.classList.replace('bg-emerald-900', 'bg-slate-800');
        }, 2000);
    } catch (err) {
        alert("‚úÖ –°–ö–û–ü–ò–†–û–í–ê–ù–û");
    }
}

        function closeLog() {
            document.getElementById('log-panel').style.display = 'none';
        }

        function startAll() {
            Object.keys(tasks).forEach(id => {
                const btn = document.getElementById(`btn-${id}`);
                if (btn && !btn.disabled) {
                    startTask(id);
                }
            });
        }

        function renderLog(id) {
            const container = document.getElementById('log-content');
            const activeLogTitle = document.getElementById('current-log-title').innerText;
            if (activeLogTitle === tasks[id].filename) {
                container.innerHTML = tasks[id].logs.join('');
                container.scrollTop = container.scrollHeight;
            }
        }

        function removeTask(id) {
    if (confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –∏–∑ —Å–ø–∏—Å–∫–∞?")) {
        // –£–¥–∞–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        const row = document.getElementById(`task-${id}`);
        if (row) row.remove();

        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –ª–æ–≥ —ç—Ç–æ–π –∑–∞–¥–∞—á–∏ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
        const activeLogTitle = document.getElementById('current-log-title').innerText;
        if (activeLogTitle === tasks[id].filename) {
            closeLog();
        }

        // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ JS
        delete tasks[id];

        // –£–¥–∞–ª—è–µ–º –∏–∑ –ø–∞–º—è—Ç–∏ Python
        pywebview.api.delete_task(id);
    }
}

        // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Python
        window.updateTaskProgress = (id, percent, status) => {
            document.getElementById(`bar-${id}`).style.width = percent + '%';
            document.getElementById(`percent-${id}`).innerText = Math.round(percent) + '%';
            if(status) document.getElementById(`status-${id}`).innerText = status;
        }

        window.addTaskLog = (id, msg) => {
            const entry = `<div class="mb-1"><span class="text-slate-700">[${new Date().toLocaleTimeString()}]</span> ${msg}</div>`;
            if (tasks[id]) {
                tasks[id].logs.push(entry);
                renderLog(id);
            }
        }
    </script>
</body>
</html>